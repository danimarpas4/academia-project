{% extends 'simulador/base.html' %}

{% block content %}
<style>
    /* --- 1. BOT√ìN FLOTANTE --- */
    .theme-toggle-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #ffc107; /* Amarillo por defecto */
        color: #000;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 1050;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        transition: transform 0.3s ease, background-color 0.3s;
    }
    .theme-toggle-btn:hover {
        transform: scale(1.1);
    }

    /* --- 2. MODO CLARO (OVERRIDES) --- */
    /* Esta p√°gina est√° dise√±ada en Oscuro por defecto. Aqu√≠ forzamos el Claro si se activa. */
    body.light-mode {
        background-color: #f8f9fa !important;
        color: #212529 !important;
    }
    
    /* Invertir textos blancos a negros */
    body.light-mode .text-light {
        color: #212529 !important;
    }
    
    /* Convertir tarjetas oscuras (Glass) a blancas */
    body.light-mode .glass-card {
        background: #ffffff !important;
        border: 1px solid #dee2e6 !important;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
    }
    
    /* Convertir tablas oscuras a claras */
    body.light-mode .table-dark {
        --bs-table-bg: transparent;
        --bs-table-color: #212529;
        color: #212529 !important;
        border-color: #dee2e6 !important;
    }
    body.light-mode .table-dark th,
    body.light-mode .table-dark td {
        color: #212529 !important;
        border-color: #dee2e6 !important;
    }
    /* Cabecera pegajosa de la tabla en modo claro */
    body.light-mode .sticky-top {
        background-color: #e9ecef !important;
        color: #000 !important;
    }
</style>

<div class="container py-5">
    
    <div class="row mb-4">
        <div class="col-12">
            <small class="text-secondary text-uppercase" style="letter-spacing: 2px;">// Telemetr√≠a del alumno</small>
            <h2 class="display-5 fw-bold text-light" style="font-family: 'Rajdhani', sans-serif;">AN√ÅLISIS DE RENDIMIENTO</h2>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm text-center py-4" style="background-color: #ffffff; border-radius: 15px;">
                <div class="card-body">
                    <h1 class="display-4 fw-bold text-dark mb-0">{{ promedio_nota }}</h1>
                    <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px;">Nota Media Global</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card h-100 shadow-sm text-center py-4 position-relative overflow-hidden" style="background-color: #ffffff; border-radius: 15px; border: 2px solid #ffc107;">
                <div class="card-body">
                    <h1 class="display-4 fw-bold text-warning mb-0">
                        {% for p in ranking %}
                            {% if p.usuario == user %}#{{ forloop.counter }}{% endif %}
                        {% empty %}
                            -
                        {% endfor %}
                    </h1>
                    <small class="text-warning text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px;">Posici√≥n Academia</small>
                    <div class="mt-2 text-muted" style="font-size: 0.65rem;">DE {{ ranking.count }} ALUMNOS</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm text-center py-4" style="background-color: #ffffff; border-radius: 15px;">
                <div class="card-body">
                    <h1 class="display-4 fw-bold text-secondary mb-0">{{ total_intentos }}</h1>
                    <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px;">Simulacros Completados</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm text-center py-4" style="background-color: #ffffff; border-radius: 15px;">
                <div class="card-body">
                    <h1 class="display-6 fw-bold text-success mb-0" style="padding-top: 10px;">ACTIVO</h1>
                    <small class="text-success text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px;">Estado de actividad</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg" style="background: rgba(33, 37, 41, 0.95); border: 1px solid rgba(255,255,255,0.1);">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="text-warning fw-bold mb-0" style="font-family: 'Rajdhani', sans-serif;">üèÜ TABLA DE L√çDERES</h3>
                            <p class="text-muted small mb-0" style="font-family: 'Share Tech Mono';">ALUMNOS DE √âLITE - TOP 50</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-warning text-dark" style="font-size: 1rem;">GLOBAL</span>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-dark table-hover mb-0 align-middle" style="border-color: rgba(255,255,255,0.1);">
                            <thead class="sticky-top" style="background-color: #1c1f23; z-index: 2;">
                                <tr style="font-family: 'Share Tech Mono'; letter-spacing: 1px; font-size: 0.9rem;">
                                    <th scope="col" class="ps-4 py-3 text-secondary">N¬∫</th>
                                    <th scope="col" class="py-3 text-secondary">RANGO</th>
                                    <th scope="col" class="py-3 text-secondary">USUARIO</th>
                                    <th scope="col" class="text-end pe-4 py-3 text-warning">PUNTOS XP</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in ranking %}
                                <tr class="{% if p.usuario == user %}table-active{% endif %}" style="transition: background 0.2s;">
                                    <td class="ps-4 fw-bold font-monospace">
                                        {% if forloop.counter == 1 %}ü•á{% elif forloop.counter == 2 %}ü•à{% elif forloop.counter == 3 %}ü•â{% else %}<span class="text-muted">#{{ forloop.counter }}</span>{% endif %}
                                    </td>
                                    <td>
                                        <span class="badge border border-secondary text-light fw-normal" style="background: rgba(255,255,255,0.05);">{{ p.rango }}</span>
                                    </td>
                                    <td>
                                        <span class="fw-bold {% if p.usuario == user %}text-warning{% else %}text-light{% endif %}">{{ p.usuario.username|upper }}</span>
                                        {% if p.usuario == user %}<span class="badge bg-warning text-dark ms-2" style="font-size: 0.6em;">T√ö</span>{% endif %}
                                    </td>
                                    <td class="text-end pe-4 font-monospace text-warning fw-bold">{{ p.preguntas_respondidas }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-muted">No hay datos de clasificaci√≥n disponibles a√∫n.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm p-4" style="border-radius: 15px;">
                <h4 class="fw-bold mb-4" style="font-family: 'Rajdhani', sans-serif;">üìà EVOLUCI√ìN DE NOTAS</h4>
                <div style="height: 300px;">
                    <canvas id="notaChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <h5 class="fw-bold text-secondary mb-3 ms-1" style="font-family: 'Rajdhani', sans-serif;">HISTORIAL DE NOTAS</h5>
            <div class="card border-0 shadow-sm" style="border-radius: 15px; overflow: hidden;">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light">
                                <tr>
                                    <th class="py-3 ps-4">Fecha</th>
                                    <th class="py-3">Tema</th>
                                    <th class="py-3 text-center">Aciertos</th>
                                    <th class="py-3 text-center">Fallos</th>
                                    <th class="py-3 text-end pe-4">Nota</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for intento in datos_grafico reversed %}
                                <tr>
                                    <td class="ps-4 fw-bold text-secondary">{{ intento.fecha|date:"d M Y" }}</td>
                                    <td>{{ intento.tema.nombre }}</td>
                                    <td class="text-center text-success fw-bold">{{ intento.aciertos }}</td>
                                    <td class="text-center text-danger fw-bold">{{ intento.fallos }}</td>
                                    <td class="text-end pe-4">
                                        <span class="badge {% if intento.nota >= 5 %}bg-success{% else %}bg-danger{% endif %} rounded-pill px-3">
                                            {{ intento.nota }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-5 text-muted">
                                        No hay datos registrados. Realiza tu primer simulacro para ver estad√≠sticas.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<button id="theme-toggle" class="theme-toggle-btn" title="Cambiar Tema">
    ‚òÄÔ∏è
</button>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        // --- 1. L√ìGICA DEL GR√ÅFICO ---
        const ctx = document.getElementById('notaChart');
        const rawData = [
            {% for intento in datos_grafico %} {{ intento.nota }}, {% endfor %}
        ];
        const rawLabels = [
            {% for intento in datos_grafico %} "{{ intento.fecha|date:'d/m' }}", {% endfor %}
        ];

        if (ctx) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: rawLabels,
                    datasets: [{
                        label: 'Nota obtenida',
                        data: rawData,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#000',
                        pointBorderColor: '#ffc107',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- 2. L√ìGICA DEL TEMA (BOT√ìN) ---
        const toggleBtn = document.getElementById('theme-toggle');
        const body = document.body;
        const currentTheme = localStorage.getItem('theme');

        // Aplicar tema guardado al cargar
        if (currentTheme === 'light') {
            body.classList.add('light-mode');
            toggleBtn.innerHTML = 'üåô'; // Icono Luna
            toggleBtn.style.backgroundColor = '#198754'; // Verde
            toggleBtn.style.color = '#fff';
        } else {
            // Por defecto Oscuro
            toggleBtn.innerHTML = '‚òÄÔ∏è'; // Icono Sol
            toggleBtn.style.backgroundColor = '#ffc107'; // Amarillo
            toggleBtn.style.color = '#000';
        }

        // Al hacer clic
        toggleBtn.addEventListener('click', () => {
            body.classList.toggle('light-mode');
            
            if (body.classList.contains('light-mode')) {
                // MODO CLARO
                localStorage.setItem('theme', 'light');
                toggleBtn.innerHTML = 'üåô';
                toggleBtn.style.backgroundColor = '#198754';
                toggleBtn.style.color = '#fff';
            } else {
                // MODO OSCURO
                localStorage.setItem('theme', 'dark');
                toggleBtn.innerHTML = '‚òÄÔ∏è';
                toggleBtn.style.backgroundColor = '#ffc107';
                toggleBtn.style.color = '#000';
            }
        });
    });
</script>
{% endblock %}